{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/Django(9)- Abstract User model & SessionAuthentication/",
    "result": {"data":{"cur":{"id":"9faef788-f40a-5db0-97c2-24efd7802c83","html":"<p>저번까지 User model을 1:1 매핑하여 Profile model을 만들어서 usermodel을 커스텀 하는 방법으로 구현해보았다. 하지만, 쓸모 없이 복잡한 부분들도 많고 이는 그렇게 권장되는 방향이 아닐 것이다. 따라서, 장고에서 제공하는 User model의 상위 클래스인 <code class=\"language-text\">AbstractUser class</code>를 이용하여 사용자 모델을 커스텀하는 방법으로 전환해보자..! 힘들겠지만, 지금이라도 바꿔야 좋을 것이다.</p>\n<h2 id=\"abstract-user-model\" style=\"position:relative;\"><a href=\"#abstract-user-model\" aria-label=\"abstract user model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Abstract User Model</h2>\n<p>우선, 우리는 이미 기존 user model을 마이그레이트해서 사용한 적이 있으므로, 이를 지워줄 필요가 있다.</p>\n<ol>\n<li>\n<p>우선, migration파일 내용을 지워준다.</p>\n</li>\n<li>\n<p>DB에서 <code class=\"language-text\">drop table profile;</code> 를 실행해준다.</p>\n</li>\n<li>\n<p>myuser/models.py에 Profile class를 없애주고, 다음을 추가한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>AbstractUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    phone_number <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'전화번호'</span><span class=\"token punctuation\">)</span>\n    address <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'주소'</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>settings.py에서 기본 사용자 객체를 우리가 정한 User로 바꿔준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># User model</span>\nAUTH_USER_MODEL <span class=\"token operator\">=</span> <span class=\"token string\">'myuser.Profile'</span></code></pre></div>\n</li>\n<li>\n<p>다시 migration을 진행해준다.</p>\n</li>\n</ol>\n<p>해당 커밋은 <a href=\"https://github.com/choieastsea/market-guri-django/commit/a2344883195545b3763aeea08df2d20c7beee572\">여기</a>를 참고한다. 다시 <code class=\"language-text\">python manage.py createsuperuser</code>로 새로운 관리자 계정을 만들고 들어가보면, 기존 user 필드에다가 전화번호와 주소를 추가할 수 있도록 되어있을 것이다.</p>\n<h3 id=\"참고-비밀번호-암호화\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0-%EB%B9%84%EB%B0%80%EB%B2%88%ED%98%B8-%EC%95%94%ED%98%B8%ED%99%94\" aria-label=\"참고 비밀번호 암호화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(참고) 비밀번호 암호화</h3>\n<p>Abstract User model을 커스텀하여 사용하면 비밀번호가 암호화되지 않고 그냥 text로 저장될 것이다. 크게 2가지 방법이 존재한다.</p>\n<ol>\n<li>ProfileSerializer에서 create, update를 오버라이딩하여 저장시 암호화하고, login 요청시 이를 check하도록 함</li>\n<li>저장 시점에서 암호화를 한다 (<a href=\"https://cjh5414.github.io/django-user-model-password-hashing/\">참고</a>)</li>\n</ol>\n<p>나는 간단하게 첫번째 방법을 이용하여 구현하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>hashers <span class=\"token keyword\">import</span> make_password\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> validated_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"\n  회원 가입시, 비밀번호 암호화 처리를 추가\n  \"\"\"</span>\n  password <span class=\"token operator\">=</span> validated_data<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">)</span>\n  validated_data<span class=\"token punctuation\">[</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> make_password<span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span>\n  user <span class=\"token operator\">=</span> Profile<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>validated_data<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> user</code></pre></div>\n<p>django에서 제공하는 encryption함수를 사용하면 된다. 또한, login을 체크할때는 장고에서 기본적으로 해당 hashing함수를 사용했다는 것을 인지하고 체크하므로 로그인도 성공적으로 되는 것을 확인할 수 있다.</p>\n<p>그럼 사용자 모델 전환 완료.!</p>\n<p><a href=\"https://github.com/choieastsea/market-guri-react/commit/292288f6e277d2f3ec0c7696ed134ba0d64dc10f\">바뀐 프론트 코드</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/d34f91ec990b97d5615fc70292f57e0965f10dc3\">바뀐 백엔드 코드</a></p>\n<p>이제 사용자 인증에 대하여 알아보도록 하자!</p>\n<h1 id=\"사용자-인증-로그인-유지\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%9D%B8%EC%A6%9D-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%9C%A0%EC%A7%80\" aria-label=\"사용자 인증 로그인 유지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사용자 인증(&#x26; 로그인 유지)</h1>\n<p>DRF는 기본적으로 SessionAuthentication과 BasicAuthentication을 사용하고 있다.</p>\n<p>이를 통하여 <code class=\"language-text\">view</code>의 <code class=\"language-text\">request</code>에서 <strong>credential data</strong>를 얻어올 수 있다. 자세한 정보는 <a href=\"https://www.django-rest-framework.org/api-guide/authentication\">DRF의 authentication 문서</a>를 참고하자. 아래는 SessionAuthentcation의 request 내용에서 얻을 수 있는 데이터이다.</p>\n<ul>\n<li>\n<p>request.user</p>\n<p><strong>Django의 User 모델</strong> (우리의 경우, default user를 커스텀 유저로 했기에 해당 모델이 들어올 것)</p>\n<p>sessionId를 기반으로 요청이 들어온 client를 구분할 수 있다.</p>\n</li>\n<li>\n<p>request.auth</p>\n<p>None</p>\n<p>참고) Oauth 등을 이용한 <code class=\"language-text\">TokenAuthentication</code>에서는 request.auth에 token 정보가 들어올 것이다.</p>\n</li>\n</ul>\n<p>따라서, 우리는 앞으로 Authorization을 할 때, <code class=\"language-text\">request.user</code>에 들어있는 정보를 통하여 인증된 사용자인지 확인할 수 있는 로직을 만들 수 있을 것이다.</p>\n<h2 id=\"sessionauthentication-in-drf\" style=\"position:relative;\"><a href=\"#sessionauthentication-in-drf\" aria-label=\"sessionauthentication in drf permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SessionAuthentication in DRF</h2>\n<p>DRF에서 기본적으로 제공하는 <code class=\"language-text\">SessionAuthentication</code>을 구현하기에 몇가지 추가적인 조건들이 필요한데, 이를 알아보도록 하자.</p>\n<ol>\n<li>\n<p>CSRF Token</p>\n<p>Unsafe HTTP method(POST, PUT, PATCH, DELETE)에 대하여 CSRF token을 검사한다. 여기서 Django와 DRF가 다른데, DRF의 api_views와 같은 어노테이션은 기본적으로 CSRF token을 검사하지 않고, <strong>요청 cookie에 session 정보가 있는 경우에만 유효한 CSRF token이 제공되는지를 검사한다!</strong> <u>CSRF Token은 HTTP header에 <code class=\"language-text\">X-CSRFToken</code> 정보로 저장되어 있어야 한다. 따라서, csrf token 정보는 브라우저에서 별도로 저장을 할 필요가 있다!</u> (따라서 js에서 접근할 수 있도록 쿠키에 저장해야한다) <a href=\"https://stackoverflow.com/questions/26639169/csrf-failed-csrf-token-missing-or-incorrect\">참고링크</a></p>\n</li>\n<li>\n<p>sessionid</p>\n<p>Django의 <code class=\"language-text\">login</code> 메소드는 로그인 성공시, 클라이언트에게 csrftoken 정보와 sessionid를 <strong>brower의 cookie에 저장하도록 응답</strong>한다.</p>\n<p>따라서, 브라우저에서는 로그인 성공시 해당 정보를 쿠키에 자동으로 저장하고 서버에 요청시 <strong>해당 credentials를 쿠키에 실어 보내줄 것</strong>이다.</p>\n<p>sessionid의 경우, 쿠키를 실어 보내기만 하면 되므로, js에서 별도의 접근이 필요가 없을 것이다.</p>\n</li>\n</ol>\n<p>이를 위해 서버와 클라이언트에서 몇가지 설정이 필요하다.</p>\n<p>(1) login 성공시 sessionid와 csrftoken을 <strong>쿠키에 저장시키는</strong> 로직이 필요하다.  -> 이는 장고의 login()이 알아서 해줌</p>\n<p>login의 request의 response로 headers를 보면 아래와 같이 Set-Cookie가 존재한다. 이는 브라우저 쿠키에 csrf토큰과 sessionId를 심도록 하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">HTTP/1.1 202 Accepted\n...\nSet-Cookie:  csrftoken=ne5Ab6JLO4w3tNY5r0AJnnIu0NSFX47c; expires=Tue, 30 Apr 2024 17:54:45 GMT; Max-Age=31449600; Path=/; SameSite=Lax\nSet-Cookie:  sessionid=08oocgdhjjpduykmxb4b8bvrih0xq2qe; expires=Tue, 16 May 2023 17:54:45 GMT; HttpOnly; Max-Age=1209600; Path=/; SameSite=Lax</code></pre></div>\n<p>해당 내용으로 브라우저에 2개(csrftoken, sessionid)의 쿠키를 심기 위해서는 서버에서 몇가지 설정이 필요하다. settings.py에 가서 아래를 추가하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">CORS_ALLOWED_ORIGINS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\nCSRF_TRUSTED_ORIGINS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\nCORS_EXPOSE_HEADERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'X-CSRFToken'</span><span class=\"token punctuation\">]</span>\nCORS_ALLOW_CREDENTIALS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\nCSRF_COOKIE_SAMESITE <span class=\"token operator\">=</span> <span class=\"token string\">'Lax'</span>\nSESSION_COOKIE_SAMESITE <span class=\"token operator\">=</span> <span class=\"token string\">'Lax'</span>\n<span class=\"token comment\"># CSRF_COOKIE_HTTPONLY = True -> 요청 headers에 X-CSRFToken을 받아야하므로 해당 쿠키를 js에서 접근가능하도록 설정</span>\nSESSION_COOKIE_HTTPONLY <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n</code></pre></div>\n<ul>\n<li>\n<p>credentials를 위해서 CORS_ALLOWED_ORIGINS는 ”*“이면 안된다.</p>\n</li>\n<li>\n<p>CSRF_TRUSED_ORIGINS는 cross domain에게 csrf token을 발급하기 위해 필요하다.</p>\n<p>또한, CSRF_COOKIE_SAMESITE는 csrf token의 쿠키 보안 정책을 의미하고, cross site 요청에 대하여 쿠키를 전송하도록 “Lax” 옵션을 주도록 한다.</p>\n<p>마지막으로, CSRF_COOKIE_HTTPONLY는 클라이언트의 js에서 CSRF token을 쿠키가 아닌 헤더의 <code class=\"language-text\">X-CSRFToken</code>으로 실어서 보내야 하므로, 비활성화한다.</p>\n<p>cross-origin의 클라이언트의 csrf token을 검사하기 위해 headers를 열어놔야 한다.</p>\n</li>\n<li>\n<p>SESSION_COOKIE_SAMESITE도 쿠키 보안 정책이며, SESSION_COOKIE_HTTPONLY는 True로 하여 클라이언트의 스크립트에서 접근할 수 없도록 한다.</p>\n</li>\n</ul>\n<p>(2) cross origin에서의 쿠키는 <strong>credentials</strong> 옵션을 설정해줘야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">CORS_ALLOW_CREDENTIALS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></code></pre></div>\n<p>Cross orgin에 대하여 헤더에 있는 X-CSRFToken는 받도록 해야하며, credential한 요청을 받도록 설정해야 request.user 와 같이 접근할 수 있다.</p>\n<p>이와 관련한 브라우저의 정책이 있고, <a href=\"https://stackoverflow.com/questions/46288437/set-cookies-for-cross-origin-requests\">해당 질문 링크</a>를 참고하여 구현하였다.</p>\n<p><strong>추가적으로, react js에서는 axios로 요청을 보낼 때, <code class=\"language-text\">withCredentials</code> 옵션을 주어 cookie정보를 서버로 보낼 수 있게 하였고, axios의 interceptors를 이용하여 <code class=\"language-text\">document.cookie</code>에 접근하도록 하였다</strong>.</p>\n<p>이제, 로그인을 수행한다면 브라우저의 쿠키에는 다음과 같이 저장되어 있을 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnElEQVQY062OSRaDMAxDc5ICGQiQkSEU2vufSzy7pYuy6aKL/54i2XKEDxkxTYzzCYOLGOcV87KBMtP2CHFEKQ/2YpqRp8JzlA8+wccRLmTkaYWwnYNULbTp0EjD2N6jHwJs56G0Rd1ozkkrYzmXpPXLOzM6LrbtySVVrRhavlXyw+lf0ReP5sV637mQiv6BWMqO6v04f/itf4V2DnQrj7pIJbyqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cookie\"\n        title=\"cookie\"\n        src=\"/static/ff7ed4366c63e534ef726db2bec04ad2/37523/index.png\"\n        srcset=\"/static/ff7ed4366c63e534ef726db2bec04ad2/e9ff0/index.png 180w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/f21e7/index.png 360w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/37523/index.png 720w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/302a4/index.png 1080w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/07a9c/index.png 1440w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/9b29b/index.png 3840w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>보면 csrftoken의 경우, httpOnly 옵션이 해제되어 있고 이는 클라이언트의 js에서 접근이 가능하다는 것이다.</p>\n<p>프론트의 코드도 간단하게 보여준다면…</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">AxiosPost</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> axiosConfig<span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    baseURL<span class=\"token operator\">:</span> <span class=\"token constant\">BASE_URL</span><span class=\"token punctuation\">,</span>\n    method<span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n    withCredentials<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> customAxios <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>axiosConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 요청을 보내기 전, cookie에 접근하여 X-CSRFToken header를 초기화</span>\n  customAxios<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'X-CSRFToken'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n      document<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'csrftoken='</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'csrftoken='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> config<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> customAxios<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>요청을 보낼 때, credentials (cookie 정보)를 보내며, csrftoken은 브라우저 쿠키에 접근(document.cookie)하여 가져와서 요청을 보내도록 한다!</p>\n<h2 id=\"로그인-세션-유지하기\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%84%B8%EC%85%98-%EC%9C%A0%EC%A7%80%ED%95%98%EA%B8%B0\" aria-label=\"로그인 세션 유지하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그인 세션 유지하기</h2>\n<p>사용자의 로그인 세션을 유지하도록 하려면, session이 유효한지 여부를 확인하는 함수가 필요할 것이다. 따라서, 클라이언트에서는 정기적으로(페이지에 진입하거나, 특정 기능을 수행할 때마다) 서버에 session의 유효성을 검토하는 요청을 보낼 수 있다.</p>\n<p>django에서는 user model에서 <code class=\"language-text\">is_authenticated</code> 함수를 사용할 수 있고, 이를 통해 유효한 요청 여부를 확인할 수 있다!</p>\n<p><code class=\"language-text\">myuser/views.py</code>에서 <code class=\"language-text\">/user/session/</code> 요청을 처리하는 함수를 만들어 주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">session_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    사용자의 인증 여부를 반환하는 함수\n    \"\"\"</span>\n    <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_200_OK<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>is_authenticated는 login시 <code class=\"language-text\">django_session</code> table에 생성된 항목인지를 확인하는 함수라고 보면 될 것이다. 따라서, 요청이 들어온 시점에서 유효한 사용자의 요청인지를 판단할 수 있다. (만약 로그인 한 후에, <code class=\"language-text\">truncate django_session;</code>으로 table을 비우고 다시 요청하면 false가 나올 것이다)</p>\n<p>이는 true, false로 브라우저에서 세션이 있는지를 확인할 수 있게 된다..! 이제 브라우저에서는 로그인되었다면 메인페이지에서 “로그인” 버튼이 아닌 “로그아웃” 버튼이 보이게 될 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABCklEQVQoz41Sy46EIBDk/7/MrJN49uDRg+JzVRR81KRIMC2b2UwnHUIXFNVFq1f6g1eaIkkS5HmOoiiQZZnPbdvAuK4LMriXKUP9LhZm23EcO87zxL7vnug4jo8kcUhMLWaF1o0nIaGMvu/RNA2stQ8y7odh8HcoQJIqZy3GYcC6rp6QxbDO84xpmuCcu2tMkrDOO+zkodAYg7IsMY7jA2S0bftRYVVVHif5g5AkPMBVqmBSGbG4Hu6QLMa8Qr62LMv9EUFJ13XQWvvWZD0oDF09PXTu9iP2kI/xodByqFMZ/SUubSKuSFTXtT8g5X+r8M8v8+s5ArFXcoT+G+QYUyTivMUefjvIcbwBR8peJuOtuCcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"main_mod\"\n        title=\"main_mod\"\n        src=\"/static/37e113a79f82fb48fc4d957cb6702c0b/37523/main_mod.png\"\n        srcset=\"/static/37e113a79f82fb48fc4d957cb6702c0b/e9ff0/main_mod.png 180w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/f21e7/main_mod.png 360w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/37523/main_mod.png 720w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/302a4/main_mod.png 1080w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/07a9c/main_mod.png 1440w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/828bd/main_mod.png 2310w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아주 멋지다! 이제 로그아웃 기능도 만들어보자.</p>\n<h3 id=\"로그아웃\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%95%84%EC%9B%83\" aria-label=\"로그아웃 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그아웃</h3>\n<p>django의 login함수는 유효한 입력에 대하여</p>\n<ul>\n<li><code class=\"language-text\">django_session</code> 테이블에 세션 정보를 추가해주는 역할</li>\n<li>Set-Cookie로 csrf token과 sessionid를 클라이언트 쿠키에 심도록 하는 역할</li>\n</ul>\n<p>을 한다.</p>\n<p>이와 반대로, <code class=\"language-text\">logout</code> 함수는</p>\n<ul>\n<li>table에서 해당 세션을 지워주는 역할</li>\n<li>Set-Cookie에서 sessionid=\"\"으로 쿠키를 지워주는 역할</li>\n</ul>\n<p>을 한다.</p>\n<p>로그아웃 함수는 다음과 같이 구현할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> logout\n<span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">logout_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logout<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_200_OK<span class=\"token punctuation\">)</span></code></pre></div>\n<p>오늘까지 서비스에서 가장 중요한 개념 중 하나인 “회원”에 대하여 알아보고, DRF에서는 이를 어떻게 인증하고 기능을 제공하는지 알아보았다. 특히, 국내 자료에는 DRF로 cross origin api를 처리하는 자료가 많지 않았기에 나름 어려웠다…</p>\n<p>그치만, 여태까지 배운 기본적인 내용을 알고 있다면 다른 서버 프레임워크에서도 무엇을 해야할지 알 수 있을 것이므로 도움이 될 것 같다.</p>\n<p>다음 시간에는 세션을 이용하여 중복 로그인을 방지하는 방법과, 서비스를 심화하는 내용에 대하여 공부해보도록 하자.</p>\n<p><a href=\"https://github.com/choieastsea/market-guri-react/commit/210d5f0eefd1942bb9fb6ab47496d24fca99eab7\">프론트 코드</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/8e2e6cc4e525e951e361fdb8f785939428701e2a\">서버 코드</a></p>","excerpt":"저번까지 User model을 1:1 매핑하여 Profile model을 만들어서 usermodel을 커스텀 하는 방법으로 구현해보았다. 하지만, 쓸모 없이 복잡한 부분들도 많고 이는 그렇게 권장되는 방향이 아닐 것이다. 따라서, 장고에서 제공하는 User model의 상위 클래스인 를 이용하여 사용자 모델을 커스텀하는 방법으로 전환해보자..! 힘들겠지만, 지금이라도 바꿔야 좋을 것이다. Abstract User Model 우선, 우리는 이미 기존 user model을 마이그레이트해서 사용한 적이 있으므로, 이를 지워줄 필요가 있다. 우선, migration파일 내용을 지워준다. DB에서  를 실행해준다. myuser/models.py에 Profile class를 없애주고, 다음을 추가한다. settings.py에서 기본 사용자 객체를 우리가 정한 User로 바꿔준다. 다시 migration을 진행해준다. 해당 커밋은 여기를 참고한다. 다시 로 새로운 관리자 계정을 만들고 들어가보…","frontmatter":{"date":"April 28, 2023","title":"(Django) 장고 api 서버를 이용한 프로젝트 [9-django user model (AbstractUser & SessionAuthentication in DRF)]","categories":"BE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/Django(9)- Abstract User model & SessionAuthentication/"}},"next":{"id":"547ad7ca-81ab-59f0-8b59-28fabce02cf6","html":"<p>이전까지 장고와 리액트 서버를 연결해보았고, 이때 생길 수 있는 문제인 CORS 정책을 해결하는 것까지 알아보았다. 오늘은 간단하게 장고에서 지원하는 사용자 모델에 대하여 알아보고, 회원가입과 로그인/로그아웃 등의 기능을 구현해보자.</p>\n<h2 id=\"장고에서-제공하는-user-model\" style=\"position:relative;\"><a href=\"#%EC%9E%A5%EA%B3%A0%EC%97%90%EC%84%9C-%EC%A0%9C%EA%B3%B5%ED%95%98%EB%8A%94-user-model\" aria-label=\"장고에서 제공하는 user model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>장고에서 제공하는 User Model</h2>\n<p>장고에서는 사용자와 관련한 많은 기능들이 포함된 User Model class가 기본적으로 제공된다. <a href=\"https://docs.djangoproject.com/en/4.2/ref/contrib/auth/\">공식문서</a></p>\n<p>settings.py에서 User관련한 것들을 추가하지 않고 migration을 진행하였다면 DB에 auth_~로 시작하는 테이블이 만들어져있을 것이다. 하지만, 여기서 제공하는 user의 필드는 id, password, last_login, is_superuser, username, first_name, last_name, email, is_staff, is_active, date_joined 정도이다. 로그인은 username과 password를 기반으로 이루어지며, is_active한 사용자만 authentication이 가능할 것이다.</p>\n<p>만약, 기본적인 user model를 커스텀하고 싶다면 어떻게 해야할까? 크게 몇가지 방법이 있다고 하지만, 마이그레이션까지 완료한 우리의 상태에서는 가장 간단한 1:1 model을 만드는 방법으로 사용자 모델을 확장시켜보도록 하자.</p>\n<h3 id=\"1--1-model을-이용한-user-model-확장\" style=\"position:relative;\"><a href=\"#1--1-model%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-user-model-%ED%99%95%EC%9E%A5\" aria-label=\"1  1 model을 이용한 user model 확장 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1 : 1 model을 이용한 user model 확장</h3>\n<p>회원과 관련된 새로운 app을 만들어서 관리하도록 하자.</p>\n<p><code class=\"language-text\">python manage.py startapp myuser</code> 로 새로운 앱을 만들어주었다. settings.py의 INSTALLED_APPS에도 <code class=\"language-text\">myuser</code>를 추가해주었다.</p>\n<p>myuser/model.py에서 다음과 같이 작성하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>db <span class=\"token keyword\">import</span> models\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User\n<span class=\"token comment\"># Create your models here.</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Profile</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># OneToOne Field로 django의 User model과 연결</span>\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>OneToOneField<span class=\"token punctuation\">(</span>User<span class=\"token punctuation\">,</span> on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">,</span> primary_key<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'계정'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\"># additional fields</span>\n    phone_number <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'전화번호'</span><span class=\"token punctuation\">)</span>\n    address <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'주소'</span><span class=\"token punctuation\">)</span>\n\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__str__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>username\n    \n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        db_table <span class=\"token operator\">=</span> <span class=\"token string\">'profile'</span>\n        verbose_name <span class=\"token operator\">=</span> <span class=\"token string\">'회원'</span>\n        verbose_name_plural <span class=\"token operator\">=</span> <span class=\"token string\">'회원들'</span>\n</code></pre></div>\n<p>model 클래스의 str 함수는 print와 같이 인스턴스를 문자열로 변환할 때 사용되며, 이는 관리자 페이지에서 식별하기 쉽게 도와준다.</p>\n<p><code class=\"language-text\">python manage.py makemigrations myuser</code> 와 <code class=\"language-text\">python manage.py migrate myuser</code> 명령어로 마이그레이션을 적용해준다.</p>\n<p>이제, 회원을 생성해보자.</p>\n<h3 id=\"관리자페이지에서-custom-user-profile-추가하기\" style=\"position:relative;\"><a href=\"#%EA%B4%80%EB%A6%AC%EC%9E%90%ED%8E%98%EC%9D%B4%EC%A7%80%EC%97%90%EC%84%9C-custom-user-profile-%EC%B6%94%EA%B0%80%ED%95%98%EA%B8%B0\" aria-label=\"관리자페이지에서 custom user profile 추가하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>관리자페이지에서 custom user profile 추가하기</h3>\n<p>myuser/admin.py에서 방금 만들어준 모델을 추가해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib <span class=\"token keyword\">import</span> admin\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Profile\n<span class=\"token comment\"># Register your models here.</span>\n\nadmin<span class=\"token punctuation\">.</span>site<span class=\"token punctuation\">.</span>register<span class=\"token punctuation\">(</span>Profile<span class=\"token punctuation\">)</span></code></pre></div>\n<p>이후, 관리자 페이지에 가면 다음과 같이 Profile 객체를 추가할 수 있다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 49.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAAB7UlEQVQoz43STU8TQRjA8f1k6oW7N7+GJJL0ool4MUbjhxAUjXCAKBp5tyLYuvJiW2yh21LqLha6bbfd7szuzN/sQJoQPfAkv8zb7jNPZsYayzzjzuRjbj94wljmKTfuPTduTlx165qszMwqj+bWmJxb5+FclvtvN8i8XmPi1SrjU8uMT68Yd6eWr8Xar3tsFByypTr5qkfO8fh25JJ3PE57IZ4fGO1QGH4o8YfyojXEaC1l2bVTZvNlFvdrvN+rmfbdXpWFnQoiTkikQKuEUWiFiuO0c+lqWJFMCKMYrUGpC4mCdF4pTRAEJEqhtEZrzXAY0en2iGPBUIRm03Qt/TZlbR5WeZPLMZOzmdqymd62ebH1nZfbNgMhEVFEFEWjCjrBEKfRwm0FdEPo9BXtIDaSRGENIhe/fwA4KF1Fa4dEHdGPymgd0x+ECClHVXZ7AU3Xo3Xepu13DSFj4rRSpbB2G+cslZos7jeY36mzsFtnfueYDz9PGESS/4f+R5osPRKrftbFdlwOT33KXpuK53PgnmHXTsyv67u/mM3+YO3ghKXCMcvFBiulBl8PXT4VjlkqNvjTCYilNEdjSSFo+R1ULCG9TZWgE0E/7JmE26UqH/NFto5csuUmXypNNiu/SV/H58vxeW9gEgoh+AvtbMBjOWitOgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"image-20230424095336175\"\n        title=\"image-20230424095336175\"\n        src=\"/static/43ab64bbaa96faed5de7682b92bfae37/37523/admin-signup.png\"\n        srcset=\"/static/43ab64bbaa96faed5de7682b92bfae37/e9ff0/admin-signup.png 180w,\n/static/43ab64bbaa96faed5de7682b92bfae37/f21e7/admin-signup.png 360w,\n/static/43ab64bbaa96faed5de7682b92bfae37/37523/admin-signup.png 720w,\n/static/43ab64bbaa96faed5de7682b92bfae37/302a4/admin-signup.png 1080w,\n/static/43ab64bbaa96faed5de7682b92bfae37/07a9c/admin-signup.png 1440w,\n/static/43ab64bbaa96faed5de7682b92bfae37/81315/admin-signup.png 1656w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>하지만, 이는 기존 User Model이 존재해야한다. 여기서는 관리자 계정을 만들면서 user가 생성되었기에 그것에 1:1로 대응되는 커스텀 유저를 만들 수 있다. 이제, 브라우저에서 로그인과 회원가입을 구현해보자.</p>\n<h2 id=\"로그인\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%9D%B8\" aria-label=\"로그인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그인</h2>\n<p>우리는 django의 user model을 사용하므로, user class에서 제공하는 함수(로그인, 로그아웃, 회원가입 등) 역시 모두 사용할 수 있다. user model이 하나 있으므로, 좀 더 간단한 로그인을 먼저 구현하고 이후에 회원가입을 구현해보자.</p>\n<p><a href=\"\">프런트를 보면 로그인과 회원가입 페이지가 구현되어 있을 것</a>이다.</p>\n<p>api 요구사항은 다음과 같다.</p>\n<blockquote>\n<p>[REQUEST]</p>\n<p>POST <a href=\"http://localhost:8000/user/login/\">http://localhost:8000/user/login/</a>\nbody : { username : string, password: string}</p>\n<p>[RESPONSE]</p>\n<p>정상 케이스 : 202\n유효하지 않은 입력 : 403</p>\n</blockquote>\n<p>우선 관리자 페이지로 만든 회원으로 로그인을 진행해보도록 하자. 로그인에 성공하면, 사용자 이름을 리턴하는 함수를 만들어주자.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 59.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABFklEQVQoz6WSvU7DMBDH/RCsfEhdWHk1pkYdWHgEdkYWWvEELCxIfAi5CSM0qFFDSgRS6tqxz/lXDk0ohS7uST+ddb47/886VhQF0jRFnue111rDWVVVXrAkSRBFEeI4RhiGkFK2DX2MNZ2tta0nIi9qhcYYCCGglPIe1ZkT4mCrL/iqa+q+FRJBlRpSldDawBjywtXWCmEJpCXK+cwJh7+58S3Yl9B4nUq85Qrxh/yX0Yb4Opos2Nl1ip3jJ3R6Q+wH/Bd7AcdBwHF0+ozDkxC7Xf4np87rcnR6HC+ZBBuOZzi/meDi9h39+wyXdxn6S5rz1eMUg7W7lmV88JChkAZMlBafgjDX2/zfymL/fGgFstvh1mYB7cWJUeCCIV0AAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"login\" title=\"login\" src=\"/static/5f0f6168fdf9f1e35a83111aae154b5a/37523/login.png\" srcset=\"/static/5f0f6168fdf9f1e35a83111aae154b5a/e9ff0/login.png 180w,\n/static/5f0f6168fdf9f1e35a83111aae154b5a/f21e7/login.png 360w,\n/static/5f0f6168fdf9f1e35a83111aae154b5a/37523/login.png 720w,\n/static/5f0f6168fdf9f1e35a83111aae154b5a/302a4/login.png 1080w,\n/static/5f0f6168fdf9f1e35a83111aae154b5a/f3a19/login.png 1086w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n<p>우선, <u>클라이언트의 입력을 검증</u>하기 위한 serailizer와 <u>사용자의 정보를 리턴</u>할 때 사용할 serializer가 필요하다. myuser/serializers.py에 다음과 같이 만들어주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> rest_framework <span class=\"token keyword\">import</span> serializers\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Profile\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>exceptions <span class=\"token keyword\">import</span> AuthenticationFailed\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> authenticate\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> User\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">LoginSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>Serializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    로그인 시, 입력을 검증하기 위한 serializer\n    \"\"\"</span>\n    username <span class=\"token operator\">=</span> serializers<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    password <span class=\"token operator\">=</span> serializers<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">validate</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        username <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">)</span>\n        password <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>username<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token keyword\">or</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n            user <span class=\"token operator\">=</span> authenticate<span class=\"token punctuation\">(</span>username<span class=\"token operator\">=</span>username<span class=\"token punctuation\">,</span> password<span class=\"token operator\">=</span>password<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> user<span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">if</span> user<span class=\"token punctuation\">.</span>is_active<span class=\"token punctuation\">:</span>\n                    data<span class=\"token punctuation\">[</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> user\n                <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                    <span class=\"token keyword\">raise</span> AuthenticationFailed<span class=\"token punctuation\">(</span><span class=\"token string\">'비활성화된 사용자입니다'</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                <span class=\"token keyword\">raise</span> AuthenticationFailed<span class=\"token punctuation\">(</span><span class=\"token string\">'아이디나 비밀번호가 다릅니다'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">raise</span> AuthenticationFailed<span class=\"token punctuation\">(</span><span class=\"token string\">'아이디와 비밀번호 모두 입력해야합니다'</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> data\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ProfileSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> Profile\n        fields <span class=\"token operator\">=</span> <span class=\"token string\">\"__all__\"</span>\n    \n<span class=\"token keyword\">class</span> <span class=\"token class-name\">UserInfoSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  \n    profile <span class=\"token operator\">=</span> ProfileSerializer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>   <span class=\"token comment\">#one to one field이므로, user에 해당하는 profile을 가져오면 됨</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> User\n        fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'username'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'profile'</span><span class=\"token punctuation\">)</span>\n        </code></pre></div>\n<p>django에서는 로그인과 관련하여, <code class=\"language-text\">authenticate</code>를 사용할 수 있다. 이는 django user model에 존재하는 username과 password로 사용자를 확인하는 것이다.</p>\n<p>이제, request를 검증하는 <code class=\"language-text\">LoginSerializer</code>와 사용자에게 profile 정보를 제공하기 위한 <code class=\"language-text\">UserInfoSerializer</code>를 이용하여 코드를 간소화할 수 있다. 아래는 myuser/views.py 에서 이를 처리해준 것이다. 로그인은 다른 기능과 url도 다르게 사용하므로 <code class=\"language-text\">@api_view</code>를 이용한 FBV로 구현해보았다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>response <span class=\"token keyword\">import</span> Response\n<span class=\"token keyword\">from</span> rest_framework<span class=\"token punctuation\">.</span>decorators <span class=\"token keyword\">import</span> api_view\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>serializers <span class=\"token keyword\">import</span> LoginSerializer<span class=\"token punctuation\">,</span> UserInfoSerializer\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> login\n<span class=\"token keyword\">from</span> rest_framework <span class=\"token keyword\">import</span> status\n\n<span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">login_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    세션 방식으로 로그인을 처리하는 함수\n    \"\"\"</span>\n    login_serailizer <span class=\"token operator\">=</span> LoginSerializer<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> login_serailizer<span class=\"token punctuation\">.</span>is_valid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 유효한 입력의 경우 로그인</span>\n        user <span class=\"token operator\">=</span> login_serailizer<span class=\"token punctuation\">.</span>validated_data<span class=\"token punctuation\">[</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">]</span>\n        user_info <span class=\"token operator\">=</span> UserInfoSerializer<span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span>\n        login<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span>user<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> user_info<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_202_ACCEPTED<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span>login_serailizer<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>LoginSerializer를 거친 user는 <code class=\"language-text\">authenticate</code>이 완료되었으므로, <code class=\"language-text\">login</code> 함수로 로그인시켜주면 된다. login함수의 역할은 기본적으로 설정되어있는 <strong>session 방식으로 서버에서 사용자의 로그인 정보를 저장하도록 수행</strong>된다.</p>\n<p>마지막으로, urls.py에서 해당 FBV를 수행하도록 매핑해준다. 프론트에서는 <code class=\"language-text\">/user/login/</code> POST 요청으로 이를 보내므로 아래와 같이 적어주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">urlpatterns <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    path<span class=\"token punctuation\">(</span><span class=\"token string\">'login/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>login_view<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">]</span></code></pre></div>\n<p>Postman에서 <a href=\"https://github.com/choieastsea/market-guri-django/commit/344f80e5a7d8a198ebe4ab026652490d83e5f17f\">여태까지의 코드</a>를 테스트해보자.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 96.11111111111111%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAATCAYAAACQjC21AAAACXBIWXMAABYlAAAWJQFJUiTwAAACAElEQVQ4y41TW5KjMAzkJDHYxi8MNhAg1M5U5f6X6i0pgeyyyQ4fHSlt05L1KHLOWNcV3ntG3/dYlgXzPON2u+G2LGyJd87t994hhICCnJQSrLVMtG2LGCNzXU5o2ggKSna7swnQfwpCIN4Yg0JrzY5Sig/okpSSudoZCFWhDw4pWkitdgE6p2/rumbrQ0BVVShIgLLZMt38ruuQU0bqEj83dR2GtkHbNPwKAt2j0oTgUfkeyjYoKJstkvOOs5NSccYbJIH5P/EvV0n5t6AxNULqkeYV1gd03mBOEbbWKKsSUlaQVcW2OtgNLEhZ9H3E19eE65SxrBPGscU0Rqxzh3FokHNAfwIsWJYlg6KVQkCIy84J8To7g13wp4tbgJ9QfDqojv/PZkgDuc2itjU0dds6KKOha73P3FF06+qx08X3NGK5joixhY8B7jmDNrh9HmlWedBpiJVifHwyrdX9fn+sVwicEYlQ5rFpmCcxGm4KGrxD6x3EhzIUQojHqlkDZSy0sXsTBHdc7P6xpu/qW9AP1ZBsbR3iMKEdZxjrEEyNxprXx4euv81wE3xMfQnjA4tSLdWzVrwdZ7v8EqSNkUzm2xfy8gvtcEUbPDpv0QWHxpnzgvyErf1KQ+qauVpJ3pbLReDCNS3/CxakLo5jwjBE3tmcPHJy7Cfyn3uaT+A38uskV5TM6yUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"image-20230427115004800\" title=\"image-20230427115004800\" src=\"/static/d290deded7ab3bf0391d6b3f20c2e1c2/37523/logintest.png\" srcset=\"/static/d290deded7ab3bf0391d6b3f20c2e1c2/e9ff0/logintest.png 180w,\n/static/d290deded7ab3bf0391d6b3f20c2e1c2/f21e7/logintest.png 360w,\n/static/d290deded7ab3bf0391d6b3f20c2e1c2/37523/logintest.png 720w,\n/static/d290deded7ab3bf0391d6b3f20c2e1c2/302a4/logintest.png 1080w,\n/static/d290deded7ab3bf0391d6b3f20c2e1c2/f8836/logintest.png 1214w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n<p>로그인을 수행하고, db에서 django_session table을 보면 세션 레코드가 추가된 것을 볼 수 있다. 각 행은 <code class=\"language-text\">session_key</code>, <code class=\"language-text\">session_data</code>, <code class=\"language-text\">expire_date</code>로 구성되어 있다.</p>\n<h3 id=\"로그인-상태-유지---session-vs-token\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%83%81%ED%83%9C-%EC%9C%A0%EC%A7%80---session-vs-token\" aria-label=\"로그인 상태 유지   session vs token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그인 상태 유지 - session vs token</h3>\n<blockquote>\n<p>사용자는 로그인을 하면 당분간 로그인을 다시 하지 않고 서비스를 이용할 수 있다고 생각한다.</p>\n</blockquote>\n<p>로그인과 관련하여 서버는 크게 둘 중 하나의 기능을 제공할 수 있는데, 이는 세션과 토큰이다.</p>\n<p>로그인 성공시,</p>\n<ol>\n<li>\n<p>세션</p>\n<p>서버에서는 보통 로그인된 사용자들을 DB에 기록해놓는다. 해당 테이블에는 sessionId와 같은 세션 키 값과 세션 정보(주로 사용자 계정의 id 등)가 들어있고, 로그인 성공시 sessionId가 생성되며 사용자에게 <code class=\"language-text\">sessionId</code>를 제공한다.</p>\n<p>이후, 사용자는 인증이 필요한 요청을 보낼때마다 서버에게 sesionId를 함께 전송하여 서버에서는 유효한 사용자임을 확인할 수 있다. 요청이 들어온 사용자를 식별할 수 있고, 중복 로그인 방지 등의 기능을 구현할 수 있다.</p>\n</li>\n<li>\n<p>토큰</p>\n<p>서버에서 로그인 성공시 유효한 토큰을 발급하여 사용자에게 제공한다. 해당 토큰은 유효기간이 있으며, 인증이 필요한 요청을 보낼 때 서버에 toekn 정보를 함께 전송하여 서버에서 해당 토큰이 유효한지 여부를 확인할 수 있다.</p>\n</li>\n</ol>\n<p>Django는 기본적으로 session 방식의 로그인을 지원하며, 위의 login함수가 호출되면 db에 존재하는 <code class=\"language-text\">django_session</code> 테이블에 세션 정보가 추가된다. (이는 settings.py의 middleware와 installed_apps에 명시되어 있음)</p>\n<h3 id=\"세션과-관련된-흐름\" style=\"position:relative;\"><a href=\"#%EC%84%B8%EC%85%98%EA%B3%BC-%EA%B4%80%EB%A0%A8%EB%90%9C-%ED%9D%90%EB%A6%84\" aria-label=\"세션과 관련된 흐름 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>세션과 관련된 흐름</h3>\n<ol>\n<li>\n<p>로그인에 성공한(authenticated) 사용자에게 sessionId를 제공해준다. sessionId는 <strong>중요한 데이터를 담고 있지 않아야 할</strong> 것이다.(db에서 세션 데이터를 찾는 용도로만 사용하면 됨)</p>\n</li>\n<li>\n<p>클라이언트는 이를 브라우저에 저장한다. (쿠키 권장, <code class=\"language-text\">HttpOnly</code> 설정하여 js에서 접근 못하도록) 또한, 사용자가 로그인 되어있는 UI/UX를 제공한다.</p>\n</li>\n<li>\n<p>사용자는 이후 인증이 필요한 요청에 대하여 sessionId를 headers에 실어서 보낸다.</p>\n</li>\n<li>\n<p>장고에서는 request 객체에서 <code class=\"language-text\">request.user</code>를 이용하여 세션을 검증할 수 있다.</p>\n</li>\n<li>\n<p>로그아웃 요청에 대하여 서버는 logout 함수를 통하여 세션을 제거해준다.</p>\n</li>\n<li>\n<p>만약 세션이 만료되었다면 클라이언트는 로그아웃 처리를 해주면 된다.</p>\n</li>\n</ol>\n<h3 id=\"세션과-관련된-설정\" style=\"position:relative;\"><a href=\"#%EC%84%B8%EC%85%98%EA%B3%BC-%EA%B4%80%EB%A0%A8%EB%90%9C-%EC%84%A4%EC%A0%95\" aria-label=\"세션과 관련된 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>세션과 관련된 설정</h3>\n<p>사용자 요청이 올때마다 세션을 리프레쉬 할 수 있다.</p>\n<p>세션의 유효기간을 정할 수 있다.</p>\n<h2 id=\"회원가입\" style=\"position:relative;\"><a href=\"#%ED%9A%8C%EC%9B%90%EA%B0%80%EC%9E%85\" aria-label=\"회원가입 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>회원가입</h2>\n<p>회원가입까지 완료해보자. api 요구사항은 다음과 같다.</p>\n<blockquote>\n<p>[REQUEST]</p>\n<p>POST <a href=\"http://localhost:8000/user/signup/\">http://localhost:8000/user/signup/</a>\nbody : {</p>\n<p>​\tuser : {username : string, password: string},</p>\n<p>​\tprofile : {first_name : string, last_name : string, phone_number : string, address: string}</p>\n<p>}</p>\n<p>[RESPONSE]</p>\n<p>정상 케이스 : 201\n유효하지 않은 입력 : 401</p>\n</blockquote>\n<p>입력 요청은 user와 profile로 나눠서 보낸다. 생각해보니, 1:1 모델은 매우 귀찮은 것 같다…</p>\n<p>회원가입도 로그인처럼 Serializer를 이용하여 검증을 하고 회원 생성까지 해줄 수 있다.</p>\n<p>우선, myuser/serializers.py 에서 다음과 같이 추가해주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> User\n        fields <span class=\"token operator\">=</span> <span class=\"token string\">\"__all__\"</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">SignupSerializer</span><span class=\"token punctuation\">(</span>serializers<span class=\"token punctuation\">.</span>ModelSerializer<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user <span class=\"token operator\">=</span> UserSerializer<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        model <span class=\"token operator\">=</span> Profile\n        fields <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'phone_number'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'address'</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token keyword\">def</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> validated_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        user_data <span class=\"token operator\">=</span> validated_data<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token string\">'user'</span><span class=\"token punctuation\">)</span> \n        user <span class=\"token operator\">=</span> User<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create_user<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>user_data<span class=\"token punctuation\">)</span> <span class=\"token comment\"># create_user 함수에 순차적으로 인자 넣어줌</span>\n        profile <span class=\"token operator\">=</span> Profile<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span>user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>validated_data<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># validated_data에서 user빠진 나머지(phone_number, address) 넣어줌</span>\n        <span class=\"token keyword\">return</span> profile</code></pre></div>\n<p>create 메소드는 serializer에서 검증한 이후에 <code class=\"language-text\">serializer.save()</code>메소드가 호출되면 실행되는 함수이다. validated_data는 dict 형식이므로 spreading해서 인자로 넣어주었다.</p>\n<p>이후 views.py에서 signup함수를 만들어주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">signup_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    회원가입을 처리하는 함수\n    \"\"\"</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    signup_serializer <span class=\"token operator\">=</span> SignupSerializer<span class=\"token punctuation\">(</span>data<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> signup_serializer<span class=\"token punctuation\">.</span>is_valid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 유효한 입력의 경우 회원가입 완료</span>\n        signup_serializer<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># create 호출</span>\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'signup success'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_201_CREATED<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span>signup_serializer<span class=\"token punctuation\">.</span>errors<span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_401_UNAUTHORIZED<span class=\"token punctuation\">)</span></code></pre></div>\n<p>serializer로 입력을 검증한 후, 입력이 유효하다면 위의 create 함수가 호출 되어 회원(User-Profile)이 만들어질 것이다!</p>\n<p>마지막으로, myuser/urls.py와 연결해주면 된다!</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\npath<span class=\"token punctuation\">(</span><span class=\"token string\">'signup/'</span><span class=\"token punctuation\">,</span> views<span class=\"token punctuation\">.</span>signup_view<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span></code></pre></div>\n<p>이제 브라우저에서 테스트해볼 수 있다. 페이지는 움직이지 않지만 성공하였다는 알림을 확인할 수 있었다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 115.55555555555554%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAABdElEQVQ4y6VV26rCMBDM//+Z+KaIrxVB5SC11N43ycis3Z4i5+EkLoyJmzhM9qa7XC7YbrfY7/c4nU7YbDao6xq0GCNSzT0eDxyPR+x2O1RVhcPhgLIs9TCEoKQpcMbMHxOmzHu/+P4Du++macL1esX5fEZRFOi6DrlGUscPg4h8BSXkpu97VUa1Kc/8fPKisG1bPJ9PJbQY5kBjOAyDqrO1aZpsjOMIR3Uk4kq1uUaF5FFCFjLBWPLZObAXOvtCuSTMBcmYYEcia7VvTZNi9beux2+ghCZ3XU/ZhCTixGEccyfMuv+dlcq6QOljslLajveVkBuOK8P9fteMp3aMhUsJOQdJxtlIQvrsUmo/O5uBn2MoNfOWVI3h7XZTZYRN65zhsCSFjd11rPgBXd/Dq/wZ+jfwxuL7E3PZTD5AAuADICHCh4hJgkJ8wDB5lI2gagUj/f59pusa6oskjLohmfgZIS7kgwT81KKkvOfD7/n6nsw8L0/gEOPNLnScAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"signup\" title=\"signup\" src=\"/static/5477e84e4571029dccbac0c5dff6b530/37523/signup.png\" srcset=\"/static/5477e84e4571029dccbac0c5dff6b530/e9ff0/signup.png 180w,\n/static/5477e84e4571029dccbac0c5dff6b530/f21e7/signup.png 360w,\n/static/5477e84e4571029dccbac0c5dff6b530/37523/signup.png 720w,\n/static/5477e84e4571029dccbac0c5dff6b530/bb2fd/signup.png 1058w\" sizes=\"(max-width: 720px) 100vw, 720px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\" decoding=\"async\">\n    </span>\n<p>또한 관리자 페이지에서 이를 확인해볼 수 있다. User와 Profile에 모두 적절하게 만들어져있다.</p>\n<p><code class=\"language-text\">create_user</code> 함수를 이용하여 사용자 모델을 만들면, <code class=\"language-text\">비밀번호 해싱</code> 등의 작업도 알아서 해주므로 아주 편하다고 볼 수 있다. 따라서, 장고에서 제공해주는 기능이 있다면 이를 활용하는 방향으로 가는 것이 장고가 추구하는 방향이다.</p>\n<p>하지만, Profile과 같이 1:1 모델로 유저를 연결하는 것은 오늘 한 것처럼 <u>불필요한 참조</u>를 낳는다. 많이 복잡해지지는 않지만, 불필요한 serializer들이 생기고 코딩할 때 자꾸 헷갈리는 것 같다. 따라서, 다음 시간에는 Basic User Model에서 상속하여 유저모델을 커스텀하는 방법을 배워보도록 하자! 아마 그러려면 migration도 다시 세팅해야할텐데, 이 부분 역시 다뤄보면 좋을 것 같다 ^_^</p>\n<p>오늘까지 회원과 관련된 많은 기능들을 직접 구현해보고 공부해보았다. 다음에는 User Model을 가능하다면 바꿔보고, session 기능을 추가하여 브라우저에서 로그인을 유지할 수 있도록 구현해보도록 하자!</p>\n<p><a href=\"https://github.com/choieastsea/market-guri-react/commit/6c2a781a8580aa8a8328be70eac002c3858bdfd4\">프론트 코드</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/344f80e5a7d8a198ebe4ab026652490d83e5f17f\">백엔드 코드- 로그인</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/2ee58c7d34062e1d5de6d725a4b8aacc227f504f\">백엔드 코드- 회원가입</a></p>","frontmatter":{"date":"April 23, 2023","title":"(Django) 장고 api 서버를 이용한 프로젝트 [8-django user model (1 to 1)]","categories":"BE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/Django(8)-User Model/"}},"prev":{"id":"55e8c2c3-78dc-5102-bb2b-c19c4883d54c","html":"<p>장고의 세션 기능은 생각보다 많은 기능들이 제공된다.</p>\n<h2 id=\"django-session-db-관리하기\" style=\"position:relative;\"><a href=\"#django-session-db-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0\" aria-label=\"django session db 관리하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Django Session DB 관리하기</h2>\n<ol>\n<li>\n<p>세션 만료</p>\n<p>기본적으로, 세션의 만료 시간이 정해져 있다. setttings.py에서 설정할 수 있는데, 몇가지 옵션들을 알아보자.</p>\n<ul>\n<li>\n<p>SESSION_EXPIRE_AT_BROWSER_CLOSE (default : False)</p>\n<p>브라우저가 종료될 때 세션이 만료되도록 하는 옵션</p>\n</li>\n<li>\n<p>SESSION_COOKIE_AGE</p>\n<p>위의 옵션이 False일 때, 세션의 유효 기간 (초 단위)</p>\n</li>\n<li>\n<p>SESSION_SAVE_EVERY_REQUEST (default : False)</p>\n<p>요청이 올때, 세션의 유효기간을 갱신할 지 여부</p>\n</li>\n</ul>\n</li>\n<li>\n<p>중복 로그인 방지</p>\n<p>장고에서는 로그인 시, <code class=\"language-text\">user_logged_in</code> signal이 발생하게 된다. 이는 비동기/GUI 프로그래밍의 event와 비슷한 것으로, eventHandler(listener)를 달아주는 것처럼 장고에서는 <code class=\"language-text\">receiver</code>를 달아주면 된다!</p>\n<p>signals은 장고에서 제공하는 몇가지가 있고, 커스텀으로도 특정 시그널을 만들 수 있다. 또한 시그널에 대한 처리는 통상적으로, 해당 시그널이 일어나는 app에서 처리하는 것이 보통이다. 따라서, 우리 서비스의 myuser/apps.py를 수정하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>apps <span class=\"token keyword\">import</span> AppConfig\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyuserConfig</span><span class=\"token punctuation\">(</span>AppConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    default_auto_field <span class=\"token operator\">=</span> <span class=\"token string\">'django.db.models.BigAutoField'</span>\n    name <span class=\"token operator\">=</span> <span class=\"token string\">'myuser'</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">ready</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">import</span> myuser<span class=\"token punctuation\">.</span>signals</code></pre></div>\n<p>myuser app의 signal을 듣도록 하겠다는 의미로 본다.</p>\n<p>그리고, myuser/models.py에서 세션을 관리하기 위한 새로운 모델을 만들어주자. 이는 django_session 테이블을 편하게 다루기 위해 필요하다.</p>\n<p><a href=\"https://stackoverflow.com/questions/50833980/how-to-prevent-multiple-login-in-django\">참고</a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserSession</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span>Profile<span class=\"token punctuation\">,</span> on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">)</span>\n    session <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>OneToOneField<span class=\"token punctuation\">(</span>Session<span class=\"token punctuation\">,</span> on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        db_table <span class=\"token operator\">=</span> <span class=\"token string\">'user_session'</span></code></pre></div>\n<p>해당 테이블은 사용자와 세션 데이터를 매칭해준다. 또한, session data는 oneToOne으로 연결하여 django_session의 변화가 생겼을 때 바로 대응이 된다.</p>\n<p>다음으로는, myuser/signals.py를 만들어서 receiver 함수를 만들어주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>signals <span class=\"token keyword\">import</span> user_logged_in\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>sessions<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Session\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>dispatch <span class=\"token keyword\">import</span> receiver\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> UserSession\n\n<span class=\"token decorator annotation punctuation\">@receiver</span><span class=\"token punctuation\">(</span>user_logged_in<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">remove_other_sessions</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 해당 사용자의 기존 세션 삭제</span>\n    Session<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>usersession__user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>delete<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># 현재 요청에 대한 새로운 세션 저장</span>\n    request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># UserSession 테이블에도 새롭게 생성</span>\n    UserSession<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get_or_create<span class=\"token punctuation\">(</span>\n        user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">,</span>\n        session_id<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>session_key\n    <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>이렇게 하면, 다른 브라우저나 환경에서 로그인했을 때, 기존의 로그인 세션을 삭제된다.!</p>\n</li>\n<li>\n<p>세션 DB 속도 향상(caching)</p>\n<p>세션의 정보를 별도의 DB에다가 두는 것은 느리다. 사용자의 요청마다 세션의 유효성을 검증해야하기 때문에 느리면 서비스 품질 저하로 이어질 수 있다. 따라서, cache와 같은 인메모리 db에다가 session 정보를 저장하는 방법도 존재한다. 물론, 캐시는 최선의 방법은 아니다. 서비스가 커질수록 캐시는 불안정하며 여러 인스턴스를 사용하는 경우에는 일관화 등의 문제가 존재할 것이다.</p>\n</li>\n</ol>\n<p>오늘의 코드는 <a href=\"https://github.com/choieastsea/market-guri-django/commit/0b39b5e04c609d1c0bd7ab7a3f21b62ce9c4276e\">여기</a>에 있다.</p>","frontmatter":{"date":"May 03, 2023","title":"(Django) 장고 api 서버를 이용한 프로젝트 [10- 세션 기능 추가 + DRF permissions]","categories":"BE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/Django(10)-Signal and Permissions/"}},"site":{"siteMetadata":{"siteUrl":"https://choieastsea.github.io","comments":{"utterances":{"repo":"choieastsea/choieastsea.github.io"}}}}},"pageContext":{"slug":"/Django(9)- Abstract User model & SessionAuthentication/","nextSlug":"/Django(8)-User Model/","prevSlug":"/Django(10)-Signal and Permissions/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}