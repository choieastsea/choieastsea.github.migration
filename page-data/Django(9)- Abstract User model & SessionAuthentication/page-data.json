{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/Django(9)- Abstract User model & SessionAuthentication/",
    "result": {"data":{"cur":{"id":"9faef788-f40a-5db0-97c2-24efd7802c83","html":"<p>저번까지 User model을 1:1 매핑하여 Profile model을 만들어서 usermodel을 커스텀 하는 방법으로 구현해보았다. 하지만, 쓸모 없이 복잡한 부분들도 많고 이는 그렇게 권장되는 방향이 아닐 것이다. 따라서, 장고에서 제공하는 User model의 상위 클래스인 <code class=\"language-text\">AbstractUser class</code>를 이용하여 사용자 모델을 커스텀하는 방법으로 전환해보자..! 힘들겠지만, 지금이라도 바꿔야 좋을 것이다.</p>\n<h2 id=\"abstract-user-model\" style=\"position:relative;\"><a href=\"#abstract-user-model\" aria-label=\"abstract user model permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Abstract User Model</h2>\n<p>우선, 우리는 이미 기존 user model을 마이그레이트해서 사용한 적이 있으므로, 이를 지워줄 필요가 있다.</p>\n<ol>\n<li>\n<p>우선, migration파일 내용을 지워준다.</p>\n</li>\n<li>\n<p>DB에서 <code class=\"language-text\">drop table profile;</code> 를 실행해준다.</p>\n</li>\n<li>\n<p>myuser/models.py에 Profile class를 없애주고, 다음을 추가한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">User</span><span class=\"token punctuation\">(</span>AbstractUser<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    phone_number <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">15</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'전화번호'</span><span class=\"token punctuation\">)</span>\n    address <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>CharField<span class=\"token punctuation\">(</span>max_length<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">,</span> blank<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span> verbose_name<span class=\"token operator\">=</span><span class=\"token string\">'주소'</span><span class=\"token punctuation\">)</span></code></pre></div>\n</li>\n<li>\n<p>settings.py에서 기본 사용자 객체를 우리가 정한 User로 바꿔준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># User model</span>\nAUTH_USER_MODEL <span class=\"token operator\">=</span> <span class=\"token string\">'myuser.Profile'</span></code></pre></div>\n</li>\n<li>\n<p>다시 migration을 진행해준다.</p>\n</li>\n</ol>\n<p>해당 커밋은 <a href=\"https://github.com/choieastsea/market-guri-django/commit/a2344883195545b3763aeea08df2d20c7beee572\">여기</a>를 참고한다. 다시 <code class=\"language-text\">python manage.py createsuperuser</code>로 새로운 관리자 계정을 만들고 들어가보면, 기존 user 필드에다가 전화번호와 주소를 추가할 수 있도록 되어있을 것이다.</p>\n<h3 id=\"참고-비밀번호-암호화\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0-%EB%B9%84%EB%B0%80%EB%B2%88%ED%98%B8-%EC%95%94%ED%98%B8%ED%99%94\" aria-label=\"참고 비밀번호 암호화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>(참고) 비밀번호 암호화</h3>\n<p>Abstract User model을 커스텀하여 사용하면 비밀번호가 암호화되지 않고 그냥 text로 저장될 것이다. 크게 2가지 방법이 존재한다.</p>\n<ol>\n<li>ProfileSerializer에서 create, update를 오버라이딩하여 저장시 암호화하고, login 요청시 이를 check하도록 함</li>\n<li>저장 시점에서 암호화를 한다 (<a href=\"https://cjh5414.github.io/django-user-model-password-hashing/\">참고</a>)</li>\n</ol>\n<p>나는 간단하게 첫번째 방법을 이용하여 구현하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>hashers <span class=\"token keyword\">import</span> make_password\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">create</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> validated_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n  <span class=\"token triple-quoted-string string\">\"\"\"\n  회원 가입시, 비밀번호 암호화 처리를 추가\n  \"\"\"</span>\n  password <span class=\"token operator\">=</span> validated_data<span class=\"token punctuation\">.</span>pop<span class=\"token punctuation\">(</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">)</span>\n  validated_data<span class=\"token punctuation\">[</span><span class=\"token string\">'password'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> make_password<span class=\"token punctuation\">(</span>password<span class=\"token punctuation\">)</span>\n  user <span class=\"token operator\">=</span> Profile<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>create<span class=\"token punctuation\">(</span><span class=\"token operator\">**</span>validated_data<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> user</code></pre></div>\n<p>django에서 제공하는 encryption함수를 사용하면 된다. 또한, login을 체크할때는 장고에서 기본적으로 해당 hashing함수를 사용했다는 것을 인지하고 체크하므로 로그인도 성공적으로 되는 것을 확인할 수 있다.</p>\n<p>그럼 사용자 모델 전환 완료.!</p>\n<p><a href=\"https://github.com/choieastsea/market-guri-react/commit/292288f6e277d2f3ec0c7696ed134ba0d64dc10f\">바뀐 프론트 코드</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/d34f91ec990b97d5615fc70292f57e0965f10dc3\">바뀐 백엔드 코드</a></p>\n<p>이제 사용자 인증에 대하여 알아보도록 하자!</p>\n<h1 id=\"사용자-인증-로그인-유지\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90-%EC%9D%B8%EC%A6%9D-%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%9C%A0%EC%A7%80\" aria-label=\"사용자 인증 로그인 유지 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사용자 인증(&#x26; 로그인 유지)</h1>\n<p>DRF는 기본적으로 SessionAuthentication과 BasicAuthentication을 사용하고 있다.</p>\n<p>이를 통하여 <code class=\"language-text\">view</code>의 <code class=\"language-text\">request</code>에서 <strong>credential data</strong>를 얻어올 수 있다. 자세한 정보는 <a href=\"https://www.django-rest-framework.org/api-guide/authentication\">DRF의 authentication 문서</a>를 참고하자. 아래는 SessionAuthentcation의 request 내용에서 얻을 수 있는 데이터이다.</p>\n<ul>\n<li>\n<p>request.user</p>\n<p><strong>Django의 User 모델</strong> (우리의 경우, default user를 커스텀 유저로 했기에 해당 모델이 들어올 것)</p>\n<p>sessionId를 기반으로 요청이 들어온 client를 구분할 수 있다.</p>\n</li>\n<li>\n<p>request.auth</p>\n<p>None</p>\n<p>참고) Oauth 등을 이용한 <code class=\"language-text\">TokenAuthentication</code>에서는 request.auth에 token 정보가 들어올 것이다.</p>\n</li>\n</ul>\n<p>따라서, 우리는 앞으로 Authorization을 할 때, <code class=\"language-text\">request.user</code>에 들어있는 정보를 통하여 인증된 사용자인지 확인할 수 있는 로직을 만들 수 있을 것이다.</p>\n<h2 id=\"sessionauthentication-in-drf\" style=\"position:relative;\"><a href=\"#sessionauthentication-in-drf\" aria-label=\"sessionauthentication in drf permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>SessionAuthentication in DRF</h2>\n<p>DRF에서 기본적으로 제공하는 <code class=\"language-text\">SessionAuthentication</code>을 구현하기에 몇가지 추가적인 조건들이 필요한데, 이를 알아보도록 하자.</p>\n<ol>\n<li>\n<p>CSRF Token</p>\n<p>Unsafe HTTP method(POST, PUT, PATCH, DELETE)에 대하여 CSRF token을 검사한다. 여기서 Django와 DRF가 다른데, DRF의 api_views와 같은 어노테이션은 기본적으로 CSRF token을 검사하지 않고, <strong>요청 cookie에 session 정보가 있는 경우에만 유효한 CSRF token이 제공되는지를 검사한다!</strong> <u>CSRF Token은 HTTP header에 <code class=\"language-text\">X-CSRFToken</code> 정보로 저장되어 있어야 한다. 따라서, csrf token 정보는 브라우저에서 별도로 저장을 할 필요가 있다!</u> (따라서 js에서 접근할 수 있도록 쿠키에 저장해야한다) <a href=\"https://stackoverflow.com/questions/26639169/csrf-failed-csrf-token-missing-or-incorrect\">참고링크</a></p>\n</li>\n<li>\n<p>sessionid</p>\n<p>Django의 <code class=\"language-text\">login</code> 메소드는 로그인 성공시, 클라이언트에게 csrftoken 정보와 sessionid를 <strong>brower의 cookie에 저장하도록 응답</strong>한다.</p>\n<p>따라서, 브라우저에서는 로그인 성공시 해당 정보를 쿠키에 자동으로 저장하고 서버에 요청시 <strong>해당 credentials를 쿠키에 실어 보내줄 것</strong>이다.</p>\n<p>sessionid의 경우, 쿠키를 실어 보내기만 하면 되므로, js에서 별도의 접근이 필요가 없을 것이다.</p>\n</li>\n</ol>\n<p>이를 위해 서버와 클라이언트에서 몇가지 설정이 필요하다.</p>\n<p>(1) login 성공시 sessionid와 csrftoken을 <strong>쿠키에 저장시키는</strong> 로직이 필요하다.  -> 이는 장고의 login()이 알아서 해줌</p>\n<p>login의 request의 response로 headers를 보면 아래와 같이 Set-Cookie가 존재한다. 이는 브라우저 쿠키에 csrf토큰과 sessionId를 심도록 하는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">HTTP/1.1 202 Accepted\n...\nSet-Cookie:  csrftoken=ne5Ab6JLO4w3tNY5r0AJnnIu0NSFX47c; expires=Tue, 30 Apr 2024 17:54:45 GMT; Max-Age=31449600; Path=/; SameSite=Lax\nSet-Cookie:  sessionid=08oocgdhjjpduykmxb4b8bvrih0xq2qe; expires=Tue, 16 May 2023 17:54:45 GMT; HttpOnly; Max-Age=1209600; Path=/; SameSite=Lax</code></pre></div>\n<p>해당 내용으로 브라우저에 2개(csrftoken, sessionid)의 쿠키를 심기 위해서는 서버에서 몇가지 설정이 필요하다. settings.py에 가서 아래를 추가하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">CORS_ALLOWED_ORIGINS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\nCSRF_TRUSTED_ORIGINS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'http://localhost:3000'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span>\nCORS_EXPOSE_HEADERS <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'X-CSRFToken'</span><span class=\"token punctuation\">]</span>\nCORS_ALLOW_CREDENTIALS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n\nCSRF_COOKIE_SAMESITE <span class=\"token operator\">=</span> <span class=\"token string\">'Lax'</span>\nSESSION_COOKIE_SAMESITE <span class=\"token operator\">=</span> <span class=\"token string\">'Lax'</span>\n<span class=\"token comment\"># CSRF_COOKIE_HTTPONLY = True -> 요청 headers에 X-CSRFToken을 받아야하므로 해당 쿠키를 js에서 접근가능하도록 설정</span>\nSESSION_COOKIE_HTTPONLY <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span>\n</code></pre></div>\n<ul>\n<li>\n<p>credentials를 위해서 CORS_ALLOWED_ORIGINS는 ”*“이면 안된다.</p>\n</li>\n<li>\n<p>CSRF_TRUSED_ORIGINS는 cross domain에게 csrf token을 발급하기 위해 필요하다.</p>\n<p>또한, CSRF_COOKIE_SAMESITE는 csrf token의 쿠키 보안 정책을 의미하고, cross site 요청에 대하여 쿠키를 전송하도록 “Lax” 옵션을 주도록 한다.</p>\n<p>마지막으로, CSRF_COOKIE_HTTPONLY는 클라이언트의 js에서 CSRF token을 쿠키가 아닌 헤더의 <code class=\"language-text\">X-CSRFToken</code>으로 실어서 보내야 하므로, 비활성화한다.</p>\n<p>cross-origin의 클라이언트의 csrf token을 검사하기 위해 headers를 열어놔야 한다.</p>\n</li>\n<li>\n<p>SESSION_COOKIE_SAMESITE도 쿠키 보안 정책이며, SESSION_COOKIE_HTTPONLY는 True로 하여 클라이언트의 스크립트에서 접근할 수 없도록 한다.</p>\n</li>\n</ul>\n<p>(2) cross origin에서의 쿠키는 <strong>credentials</strong> 옵션을 설정해줘야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">CORS_ALLOW_CREDENTIALS <span class=\"token operator\">=</span> <span class=\"token boolean\">True</span></code></pre></div>\n<p>Cross orgin에 대하여 헤더에 있는 X-CSRFToken는 받도록 해야하며, credential한 요청을 받도록 설정해야 request.user 와 같이 접근할 수 있다.</p>\n<p>이와 관련한 브라우저의 정책이 있고, <a href=\"https://stackoverflow.com/questions/46288437/set-cookies-for-cross-origin-requests\">해당 질문 링크</a>를 참고하여 구현하였다.</p>\n<p><strong>추가적으로, react js에서는 axios로 요청을 보낼 때, <code class=\"language-text\">withCredentials</code> 옵션을 주어 cookie정보를 서버로 보낼 수 있게 하였고, axios의 interceptors를 이용하여 <code class=\"language-text\">document.cookie</code>에 접근하도록 하였다</strong>.</p>\n<p>이제, 로그인을 수행한다면 브라우저의 쿠키에는 다음과 같이 저장되어 있을 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 23.333333333333332%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAnElEQVQY062OSRaDMAxDc5ICGQiQkSEU2vufSzy7pYuy6aKL/54i2XKEDxkxTYzzCYOLGOcV87KBMtP2CHFEKQ/2YpqRp8JzlA8+wccRLmTkaYWwnYNULbTp0EjD2N6jHwJs56G0Rd1ozkkrYzmXpPXLOzM6LrbtySVVrRhavlXyw+lf0ReP5sV637mQiv6BWMqO6v04f/itf4V2DnQrj7pIJbyqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cookie\"\n        title=\"cookie\"\n        src=\"/static/ff7ed4366c63e534ef726db2bec04ad2/37523/index.png\"\n        srcset=\"/static/ff7ed4366c63e534ef726db2bec04ad2/e9ff0/index.png 180w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/f21e7/index.png 360w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/37523/index.png 720w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/302a4/index.png 1080w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/07a9c/index.png 1440w,\n/static/ff7ed4366c63e534ef726db2bec04ad2/9b29b/index.png 3840w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>보면 csrftoken의 경우, httpOnly 옵션이 해제되어 있고 이는 클라이언트의 js에서 접근이 가능하다는 것이다.</p>\n<p>프론트의 코드도 간단하게 보여준다면…</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">AxiosPost</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> axiosConfig<span class=\"token operator\">:</span> AxiosRequestConfig <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    baseURL<span class=\"token operator\">:</span> <span class=\"token constant\">BASE_URL</span><span class=\"token punctuation\">,</span>\n    method<span class=\"token operator\">:</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span>\n    withCredentials<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> customAxios <span class=\"token operator\">=</span> axios<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>axiosConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 요청을 보내기 전, cookie에 접근하여 X-CSRFToken header를 초기화</span>\n  customAxios<span class=\"token punctuation\">.</span>interceptors<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'X-CSRFToken'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n      document<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span><span class=\"token string\">'csrftoken='</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span>cookie<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'csrftoken='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> config<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> customAxios<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>요청을 보낼 때, credentials (cookie 정보)를 보내며, csrftoken은 브라우저 쿠키에 접근(document.cookie)하여 가져와서 요청을 보내도록 한다!</p>\n<h2 id=\"로그인-세션-유지하기\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%9D%B8-%EC%84%B8%EC%85%98-%EC%9C%A0%EC%A7%80%ED%95%98%EA%B8%B0\" aria-label=\"로그인 세션 유지하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그인 세션 유지하기</h2>\n<p>사용자의 로그인 세션을 유지하도록 하려면, session이 유효한지 여부를 확인하는 함수가 필요할 것이다. 따라서, 클라이언트에서는 정기적으로(페이지에 진입하거나, 특정 기능을 수행할 때마다) 서버에 session의 유효성을 검토하는 요청을 보낼 수 있다.</p>\n<p>django에서는 user model에서 <code class=\"language-text\">is_authenticated</code> 함수를 사용할 수 있고, 이를 통해 유효한 요청 여부를 확인할 수 있다!</p>\n<p><code class=\"language-text\">myuser/views.py</code>에서 <code class=\"language-text\">/user/session/</code> 요청을 처리하는 함수를 만들어 주자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">session_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    사용자의 인증 여부를 반환하는 함수\n    \"\"\"</span>\n    <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_200_OK<span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>is_authenticated는 login시 <code class=\"language-text\">django_session</code> table에 생성된 항목인지를 확인하는 함수라고 보면 될 것이다. 따라서, 요청이 들어온 시점에서 유효한 사용자의 요청인지를 판단할 수 있다. (만약 로그인 한 후에, <code class=\"language-text\">truncate django_session;</code>으로 table을 비우고 다시 요청하면 false가 나올 것이다)</p>\n<p>이는 true, false로 브라우저에서 세션이 있는지를 확인할 수 있게 된다..! 이제 브라우저에서는 로그인되었다면 메인페이지에서 “로그인” 버튼이 아닌 “로그아웃” 버튼이 보이게 될 것이다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABCklEQVQoz41Sy46EIBDk/7/MrJN49uDRg+JzVRR81KRIMC2b2UwnHUIXFNVFq1f6g1eaIkkS5HmOoiiQZZnPbdvAuK4LMriXKUP9LhZm23EcO87zxL7vnug4jo8kcUhMLWaF1o0nIaGMvu/RNA2stQ8y7odh8HcoQJIqZy3GYcC6rp6QxbDO84xpmuCcu2tMkrDOO+zkodAYg7IsMY7jA2S0bftRYVVVHif5g5AkPMBVqmBSGbG4Hu6QLMa8Qr62LMv9EUFJ13XQWvvWZD0oDF09PXTu9iP2kI/xodByqFMZ/SUubSKuSFTXtT8g5X+r8M8v8+s5ArFXcoT+G+QYUyTivMUefjvIcbwBR8peJuOtuCcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"main_mod\"\n        title=\"main_mod\"\n        src=\"/static/37e113a79f82fb48fc4d957cb6702c0b/37523/main_mod.png\"\n        srcset=\"/static/37e113a79f82fb48fc4d957cb6702c0b/e9ff0/main_mod.png 180w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/f21e7/main_mod.png 360w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/37523/main_mod.png 720w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/302a4/main_mod.png 1080w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/07a9c/main_mod.png 1440w,\n/static/37e113a79f82fb48fc4d957cb6702c0b/828bd/main_mod.png 2310w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>아주 멋지다! 이제 로그아웃 기능도 만들어보자.</p>\n<h3 id=\"로그아웃\" style=\"position:relative;\"><a href=\"#%EB%A1%9C%EA%B7%B8%EC%95%84%EC%9B%83\" aria-label=\"로그아웃 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>로그아웃</h3>\n<p>django의 login함수는 유효한 입력에 대하여</p>\n<ul>\n<li><code class=\"language-text\">django_session</code> 테이블에 세션 정보를 추가해주는 역할</li>\n<li>Set-Cookie로 csrf token과 sessionid를 클라이언트 쿠키에 심도록 하는 역할</li>\n</ul>\n<p>을 한다.</p>\n<p>이와 반대로, <code class=\"language-text\">logout</code> 함수는</p>\n<ul>\n<li>table에서 해당 세션을 지워주는 역할</li>\n<li>Set-Cookie에서 sessionid=\"\"으로 쿠키를 지워주는 역할</li>\n</ul>\n<p>을 한다.</p>\n<p>로그아웃 함수는 다음과 같이 구현할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth <span class=\"token keyword\">import</span> logout\n<span class=\"token decorator annotation punctuation\">@api_view</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">logout_view</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logout<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> Response<span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"detail\"</span> <span class=\"token punctuation\">:</span> request<span class=\"token punctuation\">.</span>user<span class=\"token punctuation\">.</span>is_authenticated<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> status<span class=\"token operator\">=</span>status<span class=\"token punctuation\">.</span>HTTP_200_OK<span class=\"token punctuation\">)</span></code></pre></div>\n<p>오늘까지 서비스에서 가장 중요한 개념 중 하나인 “회원”에 대하여 알아보고, DRF에서는 이를 어떻게 인증하고 기능을 제공하는지 알아보았다. 특히, 국내 자료에는 DRF로 cross origin api를 처리하는 자료가 많지 않았기에 나름 어려웠다…</p>\n<p>그치만, 여태까지 배운 기본적인 내용을 알고 있다면 다른 서버 프레임워크에서도 무엇을 해야할지 알 수 있을 것이므로 도움이 될 것 같다.</p>\n<p>다음 시간에는 세션을 이용하여 중복 로그인을 방지하는 방법과, 서비스를 심화하는 내용에 대하여 공부해보도록 하자.</p>\n<p><a href=\"https://github.com/choieastsea/market-guri-react/commit/210d5f0eefd1942bb9fb6ab47496d24fca99eab7\">프론트 코드</a></p>\n<p><a href=\"https://github.com/choieastsea/market-guri-django/commit/8e2e6cc4e525e951e361fdb8f785939428701e2a\">서버 코드</a></p>","excerpt":"저번까지 User model을 1:1 매핑하여 Profile model을 만들어서 usermodel을 커스텀 하는 방법으로 구현해보았다. 하지만, 쓸모 없이 복잡한 부분들도 많고 이는 그렇게 권장되는 방향이 아닐 것이다. 따라서, 장고에서 제공하는 User model의 상위 클래스인 를 이용하여 사용자 모델을 커스텀하는 방법으로 전환해보자..! 힘들겠지만, 지금이라도 바꿔야 좋을 것이다. Abstract User Model 우선, 우리는 이미 기존 user model을 마이그레이트해서 사용한 적이 있으므로, 이를 지워줄 필요가 있다. 우선, migration파일 내용을 지워준다. DB에서  를 실행해준다. myuser/models.py에 Profile class를 없애주고, 다음을 추가한다. settings.py에서 기본 사용자 객체를 우리가 정한 User로 바꿔준다. 다시 migration을 진행해준다. 해당 커밋은 여기를 참고한다. 다시 로 새로운 관리자 계정을 만들고 들어가보…","frontmatter":{"date":"April 28, 2022","title":"(Django) 장고 api 서버를 이용한 프로젝트 [9-django user model (AbstractUser & SessionAuthentication in DRF)]","categories":"BE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/Django(9)- Abstract User model & SessionAuthentication/"}},"next":{"id":"e0bdf019-16fc-5372-b49e-2db69640ff06","html":"<p>react로 이것저것 할때마다 가장 귀찮은 것 중 하나가 input을 다루는 일이였다. 회원가입페이지 등을 구성하면서, input을 객체로 갖고 관리하지만 중복되는 코드가 매우 많아 귀찮다. 그래서 customHook을 만들어보았는데, 케이스에 맞게 적용할 수 있을 것 같아 업로드한다.</p>\n<p>우선, 해당 hook에서 대응가능한 event는 다음과 같다.</p>\n<ul>\n<li>Text Input event</li>\n<li>Select event : mui를 이용하여 프론트를 구성하였기에 해당 이벤트를 처리하였음</li>\n<li>check event</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> SelectChangeEvent <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@mui/material'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> ChangeEvent<span class=\"token punctuation\">,</span> Dispatch<span class=\"token punctuation\">,</span> SetStateAction<span class=\"token punctuation\">,</span> useCallback<span class=\"token punctuation\">,</span> useState <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'react'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">SetState<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> Dispatch<span class=\"token operator\">&lt;</span>SetStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">>></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token generic-function\"><span class=\"token function\">useInputObjectCallback</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>\n  initialState<span class=\"token operator\">:</span> <span class=\"token constant\">T</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token constant\">T</span><span class=\"token punctuation\">,</span>\n  SetState<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">(</span>\n    e<span class=\"token operator\">:</span> ChangeEvent<span class=\"token operator\">&lt;</span>HTMLInputElement <span class=\"token operator\">|</span> HTMLTextAreaElement<span class=\"token operator\">></span> <span class=\"token operator\">|</span> SelectChangeEvent<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n    inputType<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token generic-function\"><span class=\"token function\">useState</span><span class=\"token generic class-name\"><span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span></span><span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> onChangeInput <span class=\"token operator\">=</span> <span class=\"token function\">useCallback</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span>\n      e<span class=\"token operator\">:</span> ChangeEvent<span class=\"token operator\">&lt;</span>HTMLInputElement <span class=\"token operator\">|</span> HTMLTextAreaElement<span class=\"token operator\">></span> <span class=\"token operator\">|</span> SelectChangeEvent<span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n      inputType<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> value<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> checked <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> e<span class=\"token punctuation\">.</span>target <span class=\"token keyword\">as</span> HTMLInputElement<span class=\"token punctuation\">;</span>\n      <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>prevObj<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        <span class=\"token operator\">...</span>prevObj<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">[</span>inputType<span class=\"token punctuation\">]</span><span class=\"token operator\">:</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'checkbox'</span> <span class=\"token operator\">?</span> checked <span class=\"token operator\">:</span> value<span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">,</span> onChangeInput<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token punctuation\">{</span> useInputObjectCallback <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n</code></pre></div>\n<p>사용법은 다음과 같다.</p>\n<p>우선, 인풋 객체와 초기화 객체를 만들어준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token comment\">//model.ts</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">type</span> <span class=\"token class-name\">SignupInfo</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  username<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  password<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  passwordConfirm<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  first_name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  last_name<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  phone_number<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n  address<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> SignupInit<span class=\"token operator\">:</span> SignupInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  username<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  password<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  passwordConfirm<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  first_name<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  last_name<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  phone_number<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n  address<span class=\"token operator\">:</span> <span class=\"token string\">''</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>react input component에 사용할 때,</p>\n<ul>\n<li>custom hook을 호출하여 state, setState function, onChangeFunction을 할당받는다</li>\n<li>input 태그에 value는 <code class=\"language-text\">state.field_name</code>, onChange는 <code class=\"language-text\">(e)=>onChangeFunction(e, 'field_name')</code>으로 적어준다.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"react\"><pre class=\"language-react\"><code class=\"language-react\">&lt;input\n\tplaceholder=&quot;아이디&quot;\n\tvalue={signupObj.username}\n\tonChange={(e) =&gt; onChangeSignupInput(e, &#39;username&#39;)}\n/&gt;\n\n&lt;OutlinedInput\n  placeholder=&quot;주소&quot;\n  value={signupObj.address}\n  onChange={(e) =&gt; onChangeSignupInput(e, &#39;address&#39;)}\n/&gt;</code></pre></div>\n<p>내가 주로 사용하는 mui에서도 편하게 사용이 가능하므로 input과 관련된 별도의 처리를 해주지 않아도 된다. 물론 validation을 해야한다면 onChange가 아닌 setState를 사용하면 될 것이다.</p>\n<p>필드네임을 문자열로 관리하는 것이 좋은 방법은 아니지만, 이렇게 하면 코드를 줄일 수 있다고 생각한다~!</p>","frontmatter":{"date":"April 23, 2022","title":"(React TS) 다양한 input을 다룰 수 있는 custom hook","categories":"FE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/FE-input-custom-hook-ts/"}},"prev":{"id":"55e8c2c3-78dc-5102-bb2b-c19c4883d54c","html":"<p>장고의 세션 기능은 생각보다 많은 기능들이 제공된다.</p>\n<h2 id=\"django-session-db-관리하기\" style=\"position:relative;\"><a href=\"#django-session-db-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0\" aria-label=\"django session db 관리하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Django Session DB 관리하기</h2>\n<ol>\n<li>\n<p>세션 만료</p>\n<p>기본적으로, 세션의 만료 시간이 정해져 있다. setttings.py에서 설정할 수 있는데, 몇가지 옵션들을 알아보자.</p>\n<ul>\n<li>\n<p>SESSION_EXPIRE_AT_BROWSER_CLOSE (default : False)</p>\n<p>브라우저가 종료될 때 세션이 만료되도록 하는 옵션</p>\n</li>\n<li>\n<p>SESSION_COOKIE_AGE</p>\n<p>위의 옵션이 False일 때, 세션의 유효 기간 (초 단위)</p>\n</li>\n<li>\n<p>SESSION_SAVE_EVERY_REQUEST (default : False)</p>\n<p>요청이 올때, 세션의 유효기간을 갱신할 지 여부</p>\n</li>\n</ul>\n</li>\n<li>\n<p>중복 로그인 방지</p>\n<p>장고에서는 로그인 시, <code class=\"language-text\">user_logged_in</code> signal이 발생하게 된다. 이는 비동기/GUI 프로그래밍의 event와 비슷한 것으로, eventHandler(listener)를 달아주는 것처럼 장고에서는 <code class=\"language-text\">receiver</code>를 달아주면 된다!</p>\n<p>signals은 장고에서 제공하는 몇가지가 있고, 커스텀으로도 특정 시그널을 만들 수 있다. 또한 시그널에 대한 처리는 통상적으로, 해당 시그널이 일어나는 app에서 처리하는 것이 보통이다. 따라서, 우리 서비스의 myuser/apps.py를 수정하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>apps <span class=\"token keyword\">import</span> AppConfig\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyuserConfig</span><span class=\"token punctuation\">(</span>AppConfig<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    default_auto_field <span class=\"token operator\">=</span> <span class=\"token string\">'django.db.models.BigAutoField'</span>\n    name <span class=\"token operator\">=</span> <span class=\"token string\">'myuser'</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">ready</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">import</span> myuser<span class=\"token punctuation\">.</span>signals</code></pre></div>\n<p>myuser app의 signal을 듣도록 하겠다는 의미로 본다.</p>\n<p>그리고, myuser/models.py에서 세션을 관리하기 위한 새로운 모델을 만들어주자. 이는 django_session 테이블을 편하게 다루기 위해 필요하다.</p>\n<p><a href=\"https://stackoverflow.com/questions/50833980/how-to-prevent-multiple-login-in-django\">참고</a></p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">UserSession</span><span class=\"token punctuation\">(</span>models<span class=\"token punctuation\">.</span>Model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    user <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>ForeignKey<span class=\"token punctuation\">(</span>Profile<span class=\"token punctuation\">,</span> on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">)</span>\n    session <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>OneToOneField<span class=\"token punctuation\">(</span>Session<span class=\"token punctuation\">,</span> on_delete<span class=\"token operator\">=</span>models<span class=\"token punctuation\">.</span>CASCADE<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">class</span> <span class=\"token class-name\">Meta</span><span class=\"token punctuation\">:</span>\n        db_table <span class=\"token operator\">=</span> <span class=\"token string\">'user_session'</span></code></pre></div>\n<p>해당 테이블은 사용자와 세션 데이터를 매칭해준다. 또한, session data는 oneToOne으로 연결하여 django_session의 변화가 생겼을 때 바로 대응이 된다.</p>\n<p>다음으로는, myuser/signals.py를 만들어서 receiver 함수를 만들어주었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>auth<span class=\"token punctuation\">.</span>signals <span class=\"token keyword\">import</span> user_logged_in\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>contrib<span class=\"token punctuation\">.</span>sessions<span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> Session\n<span class=\"token keyword\">from</span> django<span class=\"token punctuation\">.</span>dispatch <span class=\"token keyword\">import</span> receiver\n<span class=\"token keyword\">from</span> <span class=\"token punctuation\">.</span>models <span class=\"token keyword\">import</span> UserSession\n\n<span class=\"token decorator annotation punctuation\">@receiver</span><span class=\"token punctuation\">(</span>user_logged_in<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">remove_other_sessions</span><span class=\"token punctuation\">(</span>sender<span class=\"token punctuation\">,</span> user<span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token operator\">**</span>kwargs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token comment\"># 해당 사용자의 기존 세션 삭제</span>\n    Session<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span><span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>usersession__user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>delete<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    \n    <span class=\"token comment\"># 현재 요청에 대한 새로운 세션 저장</span>\n    request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># UserSession 테이블에도 새롭게 생성</span>\n    UserSession<span class=\"token punctuation\">.</span>objects<span class=\"token punctuation\">.</span>get_or_create<span class=\"token punctuation\">(</span>\n        user<span class=\"token operator\">=</span>user<span class=\"token punctuation\">,</span>\n        session_id<span class=\"token operator\">=</span>request<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">.</span>session_key\n    <span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>이렇게 하면, 다른 브라우저나 환경에서 로그인했을 때, 기존의 로그인 세션을 삭제된다.!</p>\n</li>\n<li>\n<p>세션 DB 속도 향상(caching)</p>\n<p>세션의 정보를 별도의 DB에다가 두는 것은 느리다. 사용자의 요청마다 세션의 유효성을 검증해야하기 때문에 느리면 서비스 품질 저하로 이어질 수 있다. 따라서, cache와 같은 인메모리 db에다가 session 정보를 저장하는 방법도 존재한다. 물론, 캐시는 최선의 방법은 아니다. 서비스가 커질수록 캐시는 불안정하며 여러 인스턴스를 사용하는 경우에는 일관화 등의 문제가 존재할 것이다.</p>\n</li>\n</ol>\n<p>오늘의 코드는 <a href=\"https://github.com/choieastsea/market-guri-django/commit/0b39b5e04c609d1c0bd7ab7a3f21b62ce9c4276e\">여기</a>에 있다.</p>","frontmatter":{"date":"May 03, 2022","title":"(Django) 장고 api 서버를 이용한 프로젝트 [10- 세션 기능 추가 + DRF permissions]","categories":"BE","author":"choieastsea","emoji":"🙄"},"fields":{"slug":"/Django(10)-Signal and Permissions/"}},"site":{"siteMetadata":{"siteUrl":"https://choieastsea.github.io","comments":{"utterances":{"repo":"choieastsea/choieastsea.github.io"}}}}},"pageContext":{"slug":"/Django(9)- Abstract User model & SessionAuthentication/","nextSlug":"/FE-input-custom-hook-ts/","prevSlug":"/Django(10)-Signal and Permissions/"}},
    "staticQueryHashes": ["1073350324","1956554647","2938748437"]}